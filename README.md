# phpBB Sessions Auth Bundle

This allows you to use phpBB as a authentication provider and share its sessions.

It was originally developed for use on the new phpBB Symfony Website but was then open sourced.


## Configuration

First of all, make sure in your application to ignore the phpBB tables, by using (This is needed for each entity manager):

```yaml
doctrine:
    dbal:
        schema_filter: ~^(?!phpbb_)~
```        
where phpbb_ is your table prefix for tables generated by phpBB. Not making this configuration change can cause your forum tables to be deleted!

Then, if you have your forum in other database, add a custom entity_manager and dbal to your doctrine connections:
```yaml
doctrine:
    dbal:
        default_connection: default
        connections:
            # An example of your website's database connection, just leave it as it is right now
            default: 
                driver:   "%database_driver%"
                url:      "%env(resolve:DATABASE_URL)%"
                charset:  "UTF8"
            # Add the configuration to the database of your phpbb instance
            forum:
                driver:   "%forum_database_driver%"
                host:     "%forum_database_host%"
                port:     "%forum_database_port%"
                dbname:   "%forum_database_name%"
                user:     "%forum_database_user%"
                password: "%forum_database_password%"
                # Alternatively you can of course use: 
                # url:     "%env(resolve:DATABASE_URL)%"
                charset:  "UTF8"

    orm:
        entity_managers:
            # Same here, you will probably have this in your configuration
            default: 
                connection: default
            # and add this
            forum:
                connection: forum
                mappings:
                    PhpbbSessionsAuthBundle: ~
```

Then add the bundle configuration to your config file (`app/config/config.yml` in Symfony < 4 or `config/packages/phpbb_sessions_auth.yaml` in Symfony >= 4)
```yaml
phpbb_sessions_auth:
    session:
        cookiename: "phpbb_foo"             # Cookie name of your phpbb instance
        login_page: "ucp.php?mode=login"    # Login page
        force_login: false                  # if true, anonymous users will be redirected to the login page
        ip_check: 3,                        # IP address validation will check this amount of digits
    
    database:
        entity_manager: "forum"             # must match the key bellow doctrine.orm.entity_managers
        prefix: "phpbb_"                    # change this if you do not use the default "phpbb_" prefix
    
    #relation between group_id from groups table of phpBB and roles of your application
    roles:                                  
        1: ROLE_ANONYMOUS           #GUESTS
        2: ROLE_USER                #REGISTERED
        4: ROLE_MODERATOR           #GLOBAL_MODERATORS
        5: ROLE_ADMIN               #ADMINISTRATORS
        6: ROLE_BOT                 #BOTS
        # [..] Keep adding the rest of our phpbb groups to this config
```

Update your security file file to match this  (`app/config/security.yml` in Symfony < 4 or `config/packages/security.yaml` in Symfony >= 4):
```yaml
security:
    providers:
        phpbb:
            id: "phpbb.sessionsauthbundle.phpbb_user_provider"
    firewalls:
        main:
            pattern: ^/
            anonymous: true
            stateless: true # stateless should be set to true, or your symfony user may be stored in the session even if you logged out from the phpbb instance
            guard:
                authenticators:
                    - "phpbb.sessionsauthbundle.phpbb_authenticator"
```

## Missing functionality

There are some few edge functionality missing:

  * `"Remember me" key expiration length (in days)` (ie. max_autologin_time) is not used, and thus if this number is grater than 1, the user will not be autamatically logged out unless he goes to the forum.
  * "IP Check (ip_check)" has to be configured in package config. 
  * "Auto Login (allow_autologin)" does not work yet.
